name: Build All Testnets

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-all-testnets:
    runs-on: arc-infra-public

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          docker.io \
          docker-compose \
          git \
          make \
          curl \
          jq
        sudo curl --proto '=https' --tlsv1.2 --location https://github.com/mikefarah/yq/releases/download/v4.46.1/yq_linux_amd64 --output /usr/local/bin/yq
        sudo chmod 0755 /usr/local/bin/yq

    - name: Install Loki Docker Driver
      run: |
        docker plugin install grafana/loki-docker-driver --alias loki --grant-all-permissions

    - name: Build all testnets
      run: |
        make all

    - name: Verify testnet startup
      run: |
        make up-all testnet=global_network
        sleep 30
        make validate

    - name: Clean up
      if: always()
      run: |
        make down testnet=global_network
        docker system prune -af
